<!DOCTYPE html>

<html>
<head>
  <title>pult.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="pult.html">
                pult.js
              </a>
            
              
              <a class="source" href="server.html">
                server.js
              </a>
            
              
              <a class="source" href="example.html">
                example.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="static.html">
                static.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pult.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>#!<span class="hljs-regexp">/usr/</span>bin/env node</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="pult-command-line">Pult Command Line</h2>
<p>The Pult command line allows you to start any HTTP server on a local <code>.dev</code>
domain.</p>
<pre><code>npm install -g pult
</code></pre><pre><code>pult ./server
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> fs    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> spawn = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).spawn;

<span class="hljs-keyword">var</span> splitargs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'splitargs'</span>);

<span class="hljs-keyword">var</span> pult         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib'</span>);
<span class="hljs-keyword">var</span> staticServer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/static'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3 id="log">Log</h3>
<p>Log output to stderr with a prefix; do nothing if <code>options.quiet</code> is set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (!options.quiet)
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'[pult]'</span>, <span class="hljs-built_in">Array</span>.prototype.join.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">' '</span>));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3 id="read-pultrc">Read .pultrc</h3>
<p>If <code>.pultrc</code> exists in the current directory, read it and append its
contents to the command-line arguments list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (fs.existsSync(<span class="hljs-string">'.pultrc'</span>)) {
  <span class="hljs-keyword">var</span> pultrc = fs.readFileSync(<span class="hljs-string">'.pultrc'</span>, { encoding: <span class="hljs-string">'utf8'</span> });
  <span class="hljs-built_in">Array</span>.prototype.push.apply(process.argv, splitargs(pultrc.trim()));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3 id="argument-parsing">Argument parsing</h3>
<p>The <code>argv</code> array will be partially consumed by parsing any <code>-</code> short or <code>--</code>
long options and their values, leaving the command to spawn the server
process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> argv = process.argv.slice(<span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The <code>options</code> object will hold the parsed values of the command line
arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> options = {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The default method of passing the port number to the server process is
through the <code>PORT</code> environment variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  method: <span class="hljs-string">'PORT'</span>
};

<span class="hljs-keyword">while</span> (argv[<span class="hljs-number">0</span>] &amp;&amp; argv[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] == <span class="hljs-string">'-'</span>) {
  <span class="hljs-keyword">switch</span> (argv[<span class="hljs-number">0</span>]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <ul>
<li><code>--kill</code>, <code>-k</code>: Kill the Pult server.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">case</span> <span class="hljs-string">'-k'</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">'--kill'</span>:
    options.kill = argv.shift();
    <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <ul>
<li><code>--name</code>, <code>-n</code>: Set domain name for the server. Value should not
contain the <code>.dev</code> suffix.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">case</span> <span class="hljs-string">'-n'</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">'--name'</span>:
    options.name = argv[<span class="hljs-number">1</span>];
    argv = argv.slice(<span class="hljs-number">2</span>);
    <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ul>
<li><code>--port</code>, <code>-p</code>, <code>-P</code>: Pass the port number to the server process by appending
a <code>-p</code>, <code>-P</code> or <code>--port</code> argument.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">case</span> <span class="hljs-string">'-p'</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">'-P'</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">'--port'</span>:
    options.method = argv.shift();
    <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ul>
<li><code>--static</code>, <code>-s</code>: Start a <a href="static.html">static file HTTP server</a> in the
current directory instead of a specific server process.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">case</span> <span class="hljs-string">'-s'</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">'--static'</span>:
    options.static = argv.shift();
    <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ul>
<li><code>--quiet</code>, <code>-q</code>: Disable logging.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">case</span> <span class="hljs-string">'-q'</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">'--quiet'</span>:
    options.quiet = argv.shift();
    <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <ul>
<li><code>--help</code>, <code>-h</code>: Show help text.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">case</span> <span class="hljs-string">'-h'</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">'--help'</span>:
    options.help = argv.shift();
    <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Output unknown option error even if quiet was set and exit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">default</span>:
    options.quiet = <span class="hljs-literal">false</span>;
    log(<span class="hljs-string">'unknown option'</span>, argv[<span class="hljs-number">0</span>]);
    process.exit(<span class="hljs-number">1</span>);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3 id="help-text">Help text</h3>
<p>Output help text even if quiet is set then exit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (options.help) {
  options.quiet = <span class="hljs-literal">false</span>;

  log(<span class="hljs-string">'-k, --kill               Kill Pult server'</span>);
  log(<span class="hljs-string">'-n, --name "name"        Set domain name'</span>);
  log(<span class="hljs-string">'-p, -P, --port           Set port by passing -p, -P or --port to server'</span>);
  log(<span class="hljs-string">'-s, --static             Start a static file server'</span>);
  log(<span class="hljs-string">'-q, --quiet              Disable logging'</span>);

  process.exit();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3 id="kill-pult-server">Kill Pult Server</h3>
<p>Kill the Pult server if it is running, and exit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (options.kill) {
  <span class="hljs-keyword">return</span> pult.serverStatus(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, up)</span> </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-keyword">if</span> (up) {
      pult.killServer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
        process.exit();
      });
    } <span class="hljs-keyword">else</span> {
      log(<span class="hljs-string">'server not running'</span>);
      process.exit();
    }
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3 id="read-dot-pult">Read dot Pult</h3>
<p><em>Deprecation warning:</em> <code>.pult</code> files are deprecated. Names should be set in
the more powerful <code>.pultrc</code> using command-line syntax.</p>
<p>If a name has not been specified on the command line through <code>--name</code>, try
to read one from <code>.pult</code> in the current directory. If that does not exist,
use the name of the current directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (!options.name) {
  fs.readFile(<span class="hljs-string">'.pult'</span>, { encoding: <span class="hljs-string">'utf8'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
    <span class="hljs-keyword">if</span> (err &amp;&amp; err.code != <span class="hljs-string">'ENOENT'</span>) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-keyword">if</span> (data) {
      options.name = data.trim();
      log(<span class="hljs-string">'deprecation warning: .pult is deprecated in favor of .pultrc'</span>);
      log(<span class="hljs-string">'  suggested .pultrc: -n'</span>, options.name, argv.join(<span class="hljs-string">' '</span>));
    } <span class="hljs-keyword">else</span> {
      options.name = process.cwd().split(<span class="hljs-string">'/'</span>).reverse()[<span class="hljs-number">0</span>];
    }
    ensurePultServer();
  });
} <span class="hljs-keyword">else</span> ensurePultServer();</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="ensure-pult-server">Ensure Pult Server</h3>
<p>Check if the Pult server is running, and start it if it isn’t.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ensurePultServer</span><span class="hljs-params">()</span> </span>{
  pult.serverStatus(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, up)</span> </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;

    <span class="hljs-keyword">if</span> (up)
      checkVersion();
    <span class="hljs-keyword">else</span> {
      log(<span class="hljs-string">'starting server...'</span>);
      pult.spawnServer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
        checkVersion();
      });
    }
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3 id="check-version">Check Version</h3>
<p>Check the version of the running Pult server and output a warning if it does
not match.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkVersion</span><span class="hljs-params">()</span> </span>{
  pult.serverVersion(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, serverVersion, clientVersion)</span> </span>{
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-keyword">if</span> (serverVersion != clientVersion)
      log(<span class="hljs-string">'warning: server version'</span>, serverVersion, <span class="hljs-string">'!='</span>,
          <span class="hljs-string">'client version'</span>, clientVersion);
    getPorts();
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h3 id="get-ports">Get Ports</h3>
<p>Get the port number assigned to the domain name if there is a server to run
(in <code>argv</code> or with <code>--static</code>). Otherwise, list all Pult domains and ports.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPorts</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (argv.length || options.static) {
    pult.getPort(options.name, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, port, domain)</span> </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
      log(<span class="hljs-string">'http://'</span> + domain, <span class="hljs-string">'--&gt;'</span>, <span class="hljs-string">'http://localhost:'</span> + port);
      spawnServer(port);
    });
  } <span class="hljs-keyword">else</span> {
    pult.getPorts(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, ports)</span> </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> domain <span class="hljs-keyword">in</span> ports) {
        <span class="hljs-keyword">var</span> port = ports[domain];</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Do not display <code>next</code> as a link.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (domain == <span class="hljs-string">'next'</span>)
          log(<span class="hljs-string">'next:'</span>, port);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Do not display pult.dev link.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (domain != <span class="hljs-string">'pult.dev'</span>)
          log(<span class="hljs-string">'http://'</span> + domain, <span class="hljs-string">'--&gt;'</span>, <span class="hljs-string">'http://localhost:'</span> + port);
      }
      process.exit();
    });
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3 id="spawn-server">Spawn Server</h3>
<p>Spawn the server process or the static file server, passing the port number
to it using <code>options.method</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">spawnServer</span><span class="hljs-params">(port)</span> </span>{
  <span class="hljs-keyword">if</span> (options.static) {
    staticServer.listen(port);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (options.method == <span class="hljs-string">'PORT'</span>)
      process.env.PORT = port;
    <span class="hljs-keyword">else</span>
      argv.push(options.method, port);
    <span class="hljs-keyword">var</span> serverProcess = spawn(argv[<span class="hljs-number">0</span>], argv.slice(<span class="hljs-number">1</span>), { stdio: <span class="hljs-string">'inherit'</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Exit with the same code as the server process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    serverProcess.on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(code, signal)</span> </span>{
      process.exit(code);
    });
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
